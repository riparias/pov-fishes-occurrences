---
title: "Darwin Core mapping"
subtitle: "For: Monitoring of invasive alien species by the Provincial Center of Environmental Research, Province East-Flanders, Belgium"
author:
- Damiano Oldoni
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(sf)             # To convert coordinate systems
```

## Read source data

Create a data frame `occurrences` from the source data:

```{r read_inputs}
occurrences <- readr::read_csv(
  file = here::here("data", "raw", "invasieve_uitheemse_soorten.csv")
) 
```

Preview data:

```{r preview_input_data}
occurrences %>% head(n = 5)
```

# Change coordinate system

Data are provided in Belgian Lambert72 ([EPSG 31370](https://epsg.io/31370)) coordinates. DwC accepts data in WGS84 ([EPSG 4326](https://epsg.io/4326)) only.

```{r}
occurrences <- 
  occurrences %>% 
  st_as_sf(crs = st_crs(31370), wkt = "Shape") %>%
  st_transform(crs = 4326)
coords <- dplyr::as_tibble(st_coordinates(occurrences))
occurrences <- 
  dplyr::as_tibble(occurrences) %>% 
  dplyr::bind_cols(coords) %>%
  dplyr::select(-.data$Shape)
```

Preview:

```{r}
occurrences %>% head(5)
```

# Create database

Create a SQLite database with the source data, so it can be queried with SQL in the next steps:

```{r create_db}
message("Create in memory SQLite database...")
con <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")
# import occurrences
DBI::dbWriteTable(con, "occurrences", occurrences)
message("DONE")
```

# Darwin Core mapping

Create [Occurrence](https://rs.gbif.org/core/dwc_occurrence_2022-02-02.xml) extension:

```{r occurrence}
message("Map occurrences to DwC...")
dwc_occurrence_sql <- glue::glue_sql(
  readr::read_file(here::here("sql", "dwc_occurrence.sql")), 
  .con = con)
dwc_occurrence <- DBI::dbGetQuery(con, dwc_occurrence_sql)
message("DONE")
```

# Save data to CSV

```{r save_csv}
readr::write_csv(
  dwc_occurrence,
  here::here("data", "processed", "occurrence.csv"),
  na = ""
)
```
